syntax = "proto3";

import "google/protobuf/empty.proto";

package volue.mesh.protobuf;

// The greeting service definition.
service MeshService {
  rpc GetVersion(google.protobuf.Empty) returns (VersionInfo) {}

  // Read timeseries points with timskey
  rpc GetTimeseriesPoints(GetTimeseriesPointsRequest) returns (GetTimeseriesPointsReply) {}  
  // Edit (write) timeseries points with timskey
  rpc EditTimeseriesPoints(EditTimeseriesPointsRequest) returns (Status) {}  

  // Start a Mesh session, return the id of the session
  rpc StartSession(google.protobuf.Empty) returns (Guid) {}

  rpc EndSession(Guid) returns (google.protobuf.Empty) {}
  rpc Commit(Guid) returns (Status) {}
  rpc Rollback(Guid) returns (Status) {}
}

message VersionInfo {
    string version = 1;
    string name = 2;
    string build_date = 3;
    string commit = 4;
    string full_version = 5;
}

message Guid {
  // Bytes in LITTLE ENDIAN format
  bytes bytes_le = 1;
}

message Status
{
  // Will probably be replaced with 
  // https://github.com/googleapis/googleapis/blob/master/google/rpc/status.proto
  bool status = 1;
}

message UtcInterval
{
  uint64 start_time = 1;
  uint64 end_time = 2;
}

// Contains one of several ways to uniquely identify a Timeseries
message TimeseriesId
{
  oneof id {
    int64 timskey = 1;
    Guid entry_id = 2;
    string search_string = 3;
  }
}

message GetTimeseriesPointsRequest 
{
  Guid session_id = 1;
  TimeseriesId timeseries_id = 2;
  UtcInterval interval = 3;
}

message GetTimeseriesPointsReply 
{
  TimeseriesId timeseries_id = 1;
  repeated TimeseriesSegment segments = 2;
}

message EditTimeseriesPointsRequest
{
    Guid session_id = 1;
    TimeseriesId timeseries_id = 2;
    TimeseriesSegment segment = 3;
    UtcInterval interval = 4;
}

message TimeseriesPoint
{
	uint64 timestamp = 1;
	double value = 2;
	uint32 flags = 3;
}

message TimeseriesSegment
{
	repeated TimeseriesPoint points = 1;
}
